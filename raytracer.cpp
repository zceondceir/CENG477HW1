#include <iostream>
#include "parser.h"
#include "ppm.h"

typedef unsigned char RGB[3];

using namespace parser;








int main(int argc, char* argv[])
{
    // Sample usage for reading an XML scene file
    parser::Scene scene;

    scene.loadFromXml(argv[1]);

    
    
    //rendering part



    
    for(const parser::Camera& c : scene.cameras){

        int width = c.image_width;
        int height = c.image_height;

        unsigned char* image = new unsigned char [width * height * 3];

        int i = 0;
        for (int y = 0; y < height; ++y)
        {
            for (int x = 0; x < width; ++x)
            {
                // (sx , sy)

                Ray r = Ray(c.position, getPixelRay(c, x, y));

                HitRecord closestHit;

                for(const Triangle &t : scene.triangles) { //simdilik sadece ucgen iicn

                    if( ???? intersects(r,t,closestHit)){
                        
                        int pixelIndex = (y * width + x) * 3; 

                        if(closestHit.hit)
                        {                    
                            Vec3i color = ??? GetColor(hit_info, camera, scene, 0, meshTrees);
                            image[pixelIndex] = color.x; // R
                            image[pixelIndex + 1] = color.y; // G
                            image[pixelIndex + 2] = color.z; // B
                        }
                        else
                        {
                            // Lock the image buffer before writing
                            image[pixelIndex] = scene.background_color.x; // R
                            image[pixelIndex + 1] = scene.background_color.y; // G
                            image[pixelIndex + 2] = scene.background_color.z; // B
                        }

                    }

                }                
                
            }
        }
        
        
        


    }





    // raytrace(
    //     for c : cameras {
    //         ray  = findray()
            
    //         tmin = anenin atomic_cancel

    //         for o : objecets {                

    //             if intesects(ray,obj){
    //                 if dist < tmin  tmin = dist;

    //                 thispixel = obj.color

    //             }

    //         }

    //         if tmin = anenin atomic_cancel tmin = background




    //     }
        
    // )


    

    

    write_ppm("test.ppm", image, width, height);

}



/*
    
:::::::::::::::::::::::::::::::::::::=*#######################*+=:::::::::::::::::::::::::::::::::::
:::::::::::::::::::::::::::::::::=*################################*+-::::::::::::::::::::::::::::::
::::::::::::::::::::::::::::::+########################################+-:::::::::::::::::::::::::::
:::::::::::::::::::::::::::-*########****************************########*=:::::::::::::::::::::::::
:::::::::::::::::::::::::-####***************###########********************-:::::::::::::::::::::::
::::::::::::::::::::::::***********##############%################************-:::::::::::::::::::::
::::::::::::::::::::::=********##################%%####################********=::::::::::::::::::::
:::::::::::::::::::::+*****#####################=+#%#######################*****+::::::::::::::::::-
-::::::::::::::::::-****#######################=-==###########################****-:::::::::::::::::
::-:::::::::::::::-***########################=:::-=#############################**:::::::::::::::-=
--::-::::::::::::-**########################*=:::::-+%#############%###############+::::::::::::-===
=--::-::::::::::-*############%#####%**####*=:::::::-+#####*#######%%###############=::::::::::-====
:-=--::-::::::::*############%%####%*=####*+:::::::::-+####*=######%%%##############*::::::::-====--
::::---::-:::::+############%%%###%*==####==::::::::::-+###+=+######%%###############=:::::-====----
::::--=--:::::-#######%####%%%%##%*===###++::::::::::::-###+:-=####%%%%##############+:::--===------
:::::::---::::+###########%%##%#%*:-==##*:-:::::::::::::=##+:::+####%%%%#############*-:------------
:::::::::--::-*##########%%#=*%%#-:-==##-:=::::::::::::::+#+::::*##*=#%%#############*------:----:::
--:::::::::--=#######%##%%%==*%%=:::==**::-::::::::::::::-#+:::::*#=-=#%%#############=---:::::::::-
::-::::::::::*#######%##%#===*%+:-=+*++-:-::::::::::::::::-***#*+*#-:-=#%#############+-:::::::::---
::-::::::::::########%#%%+===*%#+=-====++::::::::::::::::-*=-====+%#=:-=##############*::::::::----:
::-:::::::::-%#######%%%#===+%+--*%###%*:::::::::::::::::::=%%#%%%*-*#--+##############::::::---::::
::-:::::::::=%#######%%##==*#--+%#######+::::::::::::::::.=%######%#-=#--+#############-:::--:::::::
-:-:::::::::+%#######%%#*=+#-::%##%%%%###:::::::::::::::::%##%%%%##%#:=%--+############=-:::::::::::
-:-:::::::::*%#######%##*=%+:.*%##%%%%##%-:::::::::::::::-%##%%%%###%-:#+:=############+::::::::::::
-:-:::::::::*%%#########+=%=..%###%%%%##%+:::::::::::::::-%##%%%%%##%=.+*:-%%##########+::::::::::::
-:-:::::::::#%%#########++%-..%%##%%%%##%=:::::::::::::::-%##%%%%###%=.**::%%##########+::::::::::::
-:-:::::::::#%%#########++%=..+%*=-*%%##%-::::::::::::::::%#=-*%%##%%-.#=::#%##########+::::::::::::
-:-:::::::::#%%#########+=+=..:%:...*###%:::::::::::::::::#-..:####%*.:+:::#%##########+::::::::::::
-:-:::::::::#%%#########+===:..+*::+###%*::::::::::::::::::%+=*###%#:.:::::#%##########+::::::::::::
-:-:::::::::#%%#########+===:::.-#%###%+:::::::::::::::::::-%%##%%+::::::::#%##########=::::::::::::
-:-:::::::::#%%#########+===::::::=++=--::::::::::::::::::::=+*+==:::::::::#%##########=::::::::::::
-:-:::::::::#%%#########+===:::::::::::::::::::::::::::::::::::::::::::::::#%##########=::::::::::::
-:-:::::::::%%%#########+===::::::::::::::::::::=+::::::::::::::::::::::::=%%##########=::::::::::::
-:-:::::::::%%%#########+===:::::::::::::::::::--:::::::::::::::::::::::::+%%%#########=::::::::::::
-:-:::::::::%%%##########===-:::::::::::::::::::::::::::::::::::::::::::::#%%%#########=::::::::::::
-:-:::::::::%%%%########%+===::::::::::::::::::::::::::::::::::::::::::::*%%%%#########=::::::::::::
-:-:::::::::%%%%########%#====:::::::::::::::-----------::::::::::::::::=%%%%%#########=::::::::::::
-:-:::::::::#%%%########%%#====::::::::::::::#++++++++++:::::::::::::::-#%%%%%#########+::::::::::::
::-:::::::::#%%%########%%%#+===-::::::::::::*=-------==::::::::::::::=%%%%%%%#########+::::::::--::
::-:::::::::#%%%########%%%%%#*===-::::::::::-=-------=-::::::::::::+#%%%%%%%%#########+::-:::::--::
::-:::::::::#%%%########%%%%%%%%#*===-::::::::-=======:::::::::::=*%%%%%%%%%%%#########*::-:::::--::
::-:::::::::#%%%########%%%%%%%%%%%%*+=-:::::::::::::::::::::-=#%%%%%%%%%%%%%%#########*::-:::::--::
::-:::::::::#%%%#########%%%%%%%%%%%%%%#+=-:::::::::::::::-=#%%%%%%%%%%%%%%%%%#########*---::::---::
::-:::::::::*%%%%########%%%%#%%%%%%%%%%%*=++=-:::::::-=====%%%%%%%%%%%%%%%%%%######%##*-------=-=-:
::::::::::::*%%%%########%%%%#%%%%%%%%%%%#=======+==========#%%%%%%%%#%%%%%%%%######%##*---------=--
:-::::::::::+%%%%########%%%%+%%%%%%%%%+=+==================-:*%%%%%%*%%%%%%%%#####%%##*----------::
:-::::::::::+%%%%########%%%%=%%%%%%%#===*===================..*%%%%#*%%%%%%%%#####%%%#*------------
::::::::::::+%%%%%#######%%%%++%%%%%*=-==+==================+:..-*%%**%%%%%%%######%%%##------------
::::::::::::+%%%%%#######%%%%*:#%#+=---=+=================-::-.....--#%%%%%%%######%%%##------------
::::::::::::=%%%%%#######%%%%#-==------=+================::::-........:=#%%%%######%%%#*------------
::::::::::::=%%%%%%#######%#=-----------+==============-::::::...........-%%%#####%%%%#*------------
::::::::::::-%%%%%%######*--------------==============-:::::=............=%%%#####%%%%#+------------
:::::::::::::%%%%%%%#####*--------------=++====+======-:---:=............*%%%####%%%%##=------------
:::::::::::::#%*#%%%%####*---------------+=============-:::-............:#%%%####%%%%#+-------------
:::::::::::::+%**%%%%#####---------------============-:::::-............-%%%####%%%#%#--------------
:::::::::::::-%#:#%%%%####+---------------+========::::::::-............=%%%###%%%=#%+--------------
:::::::::::::-*%--#%%%%###*---------------++++++++--------+.............*%%%##%%%++%=..-------------
:::::::::::=+-:%+.-%%%%%###=--------------=****==========+:............:#%%%#%%%=:#-....:=----------
::::::::::-.-+++%:.-#%%%%##+-------:.....:-+***===========.............+%%%%%%%=:+:...:=++=----:----
::::::::::==-:-+**:.:*%%%%%#---::..........:**+=========+:............:#%%%%%#-....:-++=:-+-::::::::
::::::::::=====:-**=:.+%%%%%*...............=*+=========:.............=%%%%%*:...:=+=-:=====::::::::
:::::::::+=======:-+++-:#%%%%-..............:*==========.............:#%%%%=..:=++--========-:::::::
::::::::-==========-:-++==#%%#::--=:.........=========+:.......-::..:#%%%*::=++--===========*-::::::
::::::::=+============::=++*#%#=--+:.........:========-........++=++*%%*==+=--================::::::
::::::::+=+=============-::::-*#=-+:..........========:.......:+-=-*#*++=--================+=+-:::::
::-::::=+==+==============+====-:+=:...........+======........:+:==+==:-+=================+===+:::::
    
*/



Vec3f getPixelRay(const Camera &c, const int i, const int j){

    Vec3f e = c.position;
    Vec3f v = c.up;
    Vec3f w = c.gaze * -1;
    Vec3f u = v ^ w;


    float l = c.near_plane.x;
    float r = c.near_plane.y;
    float b = c.near_plane.z;
    float t = c.near_plane.w;

    Vec3f m = e + w * ( -1 * c.near_distance);
    Vec3f q = m + u * l + v * t;
    
    float su = (i+0.5) * (r-l) / c.image_width;
    float sv = (j+0.5) * (t-b) / c.image_height;
    
    Vec3f s = q + u * su - v * sv;

    return s - e;


}



















